<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Sharepoint</title>
    <link rel="icon" type="image/png" href="./images/ukbrum_png.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="roblox-search.css">
</head>

<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>

<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn" style="position: fixed; top: 20px; left: 20px; z-index: 10002; background: #dc2626; color: white; border: none; border-radius: 8px; padding: 12px; width: 48px; height: 48px; display: block;">
        <i class="fas fa-bars"></i>
    </button>
    <div class="mobile-overlay" id="mobileOverlay"></div>
    <div id="sidebar-container"></div>
    <!-- <nav class="sidebar" id="sidebar">
        <ul class="sidebar-nav">
            <li><a href="index.html" class="nav-link active">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a></li>
            <li><a href="ranks.html" class="nav-link">
                <i class="fas fa-calendar-alt"></i>
                <span>Schedule</span>
            </a></li>
            <li><a href="melonlysystem.html" class="nav-link">
                <i class="fas fa-clipboard-list"></i>
                <span>Melonly System</span>
            </a></li>
            <li><a href="resources.html" class="nav-link">
                <i class="fas fa-tools"></i>
                <span>Resources</span>
            </a></li>
            <li><a href="forms.html" class="nav-link">
                <i class="fas fa-file-alt"></i>
                <span>Forms</span>
            </a></li>
        </ul>
        <div class="sidebar-logout">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span class="logout-text">Logout</span>
            </button>
        </div>
    </nav> -->

    <main class="main-content">
        <section class="top-search">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="siteSearch" placeholder="Search Sharepoint Content..." class="search-input" autocomplete="off">
                    <button class="filter-btn"><i class="fas fa-filter"></i></button>
                </div>
            </div>
            <div id="searchResults" class="search-results"></div>
        </section>
        
        <section class="greeting-section">
            <h1 id="dynamicGreeting" class="greeting-text">Good Afternoon</h1>
            <div class="quick-access-grid">
                <div class="quick-box" onclick="window.location.href='#announcements'">
                    <i class="fas fa-bullhorn"></i>
                    <h4>Announcements</h4>
                </div>
                <div class="quick-box" onclick="window.location.href='ranks.html'">
                    <i class="fas fa-clock"></i>
                    <h4>Schedule</h4>
                </div>
                <div class="quick-box" onclick="openIncidentReport()">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Incident Report</h4>
                </div>
                <div class="quick-box" onclick="window.location.href='forms.html'">
                    <i class="fas fa-file-alt"></i>
                    <h4>Trial Logs</h4>
                </div>
                <div class="quick-box" onclick="window.location.href='resources.html'">
                    <i class="fas fa-tools"></i>
                    <h4>Staff Material</h4>
                </div>
                <div class="quick-box" onclick="window.location.href='#contacts'">
                    <i class="fas fa-address-book"></i>
                    <h4>Contacts</h4>
                </div>
            </div>
        </section>

        <section class="announcements">
            <h2><i class="fas fa-bullhorn"></i> Recent Notices</h2>
            <div id="announcementsContainer">
                <!-- Announcements will be loaded dynamically -->
            </div>
        </section>
                


                        

        
        <section class="roblox-search">
            <h2><i class="fas fa-search"></i> Roblox User Search</h2>
            <p class="section-description">Search for Roblox users to view their profile information and avatar details.</p>
            <div class="roblox-search-container">
                <input type="text" id="robloxSearch" placeholder="Enter Roblox username..." class="roblox-search-input">
                <button onclick="searchRobloxUser()" class="roblox-search-btn">Search User</button>
            </div>
            <div id="robloxResults"></div>
        </section>
        
        <section class="info-grid">
            <div class="info-box" onclick="window.location.href='ranks.html'">
                <i class="fas fa-calendar-alt info-box-icon"></i>
                <h3>Staff Schedule</h3>
                <p>View all events and upcoming meetings for the Staff team</p>
            </div>
            <div class="info-box" onclick="window.location.href='forms.html'">
                <i class="fas fa-clipboard-list info-box-icon"></i>
                <h3>Trial Logs</h3>
                <p>Log and manage staff member trials</p>
            </div>
            <div class="info-box" onclick="window.location.href='resources.html'">
                <i class="fas fa-tools info-box-icon"></i>
                <h3>Resources</h3>
                <p>Staff guides, commands, and helpful tools</p>
            </div>
        </section>
        
        <section class="announcements"> 
            <h2><i class="fa-solid fa-bug"></i>Website Administrators</h2>
            <p>Please also notify one of our Website Administrators when one of the guidelines are outdated.</p>
            <br>    
            <div class="staff-grid">
                        <div class="staff-card">
                            <div class="staff-avatar developer">
                                <img src="" alt="" onerror="this.src='images/finn.png'">
                                <div class="role-badge developer">Lead Website Administrator</div>
                            </div>
                            <div class="staff-info">
                                <h3>Finn</h3>
                            </div>
                        </div>
                        <div class="staff-card">
                            <div class="staff-avatar developer">
                                <img src="" alt="" onerror="this.src='images/mrtrappy.png'">
                                <div class="role-badge developer">Website Administrator</div>
                            </div>
                            <div class="staff-info">
                                <h3>MrTrappy</h3>
                            </div>
                        </div>
                        <div class="staff-card">
                            <div class="staff-avatar developer">
                                <img src="" alt="" onerror="this.src='images/karam.png'">
                                <div class="role-badge developer">Website Administrator</div>
                            </div>
                            <div class="staff-info">
                                <h3>act1v.bov</h3>
                            </div>
                        </div>
                    </div>
        </section>



    </main>

    <div id="footer-container"></div>


    <script src="js/components.js"></script>
    <script src="js/main.js"></script>
    <script src="js/new-auth.js"></script>
    <script src="js/security.js"></script>
    <script src="js/forms.js"></script>
    <script src="js/roblox-search.js"></script>
    <script>
        async function loadAnnouncements() {
            const container = document.getElementById('announcementsContainer');
            
            try {
                const response = await fetch('./api/load.php?type=announcements');
                const announcements = await response.json();
                
                if (announcements.length === 0) {
                    container.innerHTML = `
                        <div class="announcement">
                            <i class="fas fa-info-circle announcement-icon"></i>
                            <div class="announcement-content">
                                <h4>There are no current notices</h4>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = announcements.slice(0, 3).map(announcement => `
                        <div class="announcement">
                            <i class="fas fa-bullhorn announcement-icon"></i>
                            <div class="announcement-content">
                                <h4>${announcement.title}</h4>
                                <p>${announcement.content}</p>
                                <span class="date">Posted: ${new Date(announcement.created).toLocaleDateString()}${announcement.postedBy ? ` by ${announcement.postedBy}` : ''}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                container.innerHTML = `
                    <div class="announcement">
                        <i class="fas fa-exclamation-triangle announcement-icon"></i>
                        <div class="announcement-content">
                            <h4>Error loading announcements</h4>
                        </div>
                    </div>
                `;
            }
        }
        
        function updateGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = 'Good evening';
            
            if (hour >= 5 && hour < 12) greeting = 'Good Morning';
            else if (hour >= 12 && hour < 18) greeting = 'Good Afternoon';
            else greeting = 'Good Evening';
            
            const greetingEl = document.getElementById('dynamicGreeting');
            const user = newAuthSystem.getCurrentUser();
            const userName = user ? user.robloxUsername : 'Staff Member';
            
            greetingEl.innerHTML = `<span style="font-size: 1.2em; font-weight: 800;">${greeting}, ${userName}</span><br><span style="font-size: 0.6em; opacity: 0.7; margin-top: 10px; display: block;">Welcome back to the Sharepoint!</span>`;
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadAnnouncements();
            updateGreeting();
            setInterval(updateGreeting, 60000);
        });
        
        // Update greeting when user logs in
        document.addEventListener('userLoggedIn', updateGreeting);
        
        function siteSearch() {
            const query = document.getElementById('siteSearch').value.toLowerCase();
            const results = document.getElementById('searchResults');
            
            if (!query) {
                results.innerHTML = '';
                return;
            }
            
            const searchableElements = document.querySelectorAll('h1, h2, h3, h4, p, li');
            const matches = [];
            
            searchableElements.forEach(el => {
                if (el.textContent.toLowerCase().includes(query)) {
                    matches.push({
                        text: el.textContent.substring(0, 100) + '...',
                        element: el
                    });
                }
            });
            
            if (matches.length > 0) {
                results.innerHTML = matches.map(match => `
                    <div class="search-result" onclick="scrollToElement(this)">
                        <p>${match.text}</p>
                    </div>
                `).join('');
            } else {
                results.innerHTML = '<div class="no-results">No results found</div>';
            }
        }
        
        function openAnnouncementForm() {
            if (!newAuthSystem.isAuthenticated()) {
                alert('Please log in first.');
                return;
            }
            
            if (!newAuthSystem.hasPermission('senior_management')) {
                alert('Access denied. Only Senior Management+ can create announcements.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'form-modal';
            modal.innerHTML = `
                <div class="form-modal-content">
                    <h3>Create Staff Announcement</h3>
                    <form id="announcementForm" onsubmit="saveAnnouncement(event)">
                        <input type="text" id="announcementTitle" placeholder="Announcement Title" required>
                        <textarea id="announcementContent" placeholder="Announcement Content" required></textarea>
                        <select id="announcementIcon">
                            <option value="bullhorn">Bullhorn</option>
                            <option value="info-circle">Info</option>
                            <option value="exclamation-triangle">Warning</option>
                        </select>
                        <button type="submit">Create Announcement</button>
                        <button type="button" onclick="this.closest('.form-modal').remove()">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveAnnouncement(event) {
            event.preventDefault();
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            const icon = document.getElementById('announcementIcon').value;
            
            try {
                const announcement = announcementManager.createAnnouncement({
                    title,
                    content,
                    icon
                });
                
                // Add to page immediately
                const container = document.getElementById('announcementsContainer');
                const announcementEl = document.createElement('div');
                announcementEl.className = 'announcement';
                announcementEl.innerHTML = `
                    <i class="fas fa-${icon} announcement-icon"></i>
                    <div class="announcement-content">
                        <h4>${title}</h4>
                        <p>${content}</p>
                        <span class="date">Posted: ${announcement.date}</span>
                    </div>
                `;
                container.insertBefore(announcementEl, container.firstChild);
                
                document.querySelector('.form-modal').remove();
                
            } catch (error) {
                securityManager.showNotification(error.message, 'warning');
            }
        }
        
        function openFormBuilder() {
            if (!newAuthSystem.isAuthenticated()) {
                alert('Please log in first.');
                return;
            }
            
            if (!newAuthSystem.hasPermission('senior_management')) {
                alert('Access denied. Only Senior Management+ can create forms.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'form-modal';
            modal.innerHTML = `
                <div class="form-modal-content form-builder">
                    <h3>Enhanced Form Builder</h3>
                    <div class="form-builder-content">
                        <input type="text" id="formName" placeholder="Form Name" required>
                        <div id="formFields">
                            <div class="field-item">
                                <input type="text" placeholder="Field Label" class="field-label">
                                <select class="field-type">
                                    <option value="text">Text Input</option>
                                    <option value="textarea">Text Area</option>
                                    <option value="select">Dropdown</option>
                                    <option value="checkbox">Checkbox</option>
                                </select>
                                <button type="button" onclick="removeField(this)">Remove</button>
                            </div>
                        </div>
                        <button type="button" onclick="addField()">Add Field</button>
                        <div class="form-actions">
                            <button type="button" onclick="saveEnhancedForm()">Create Form</button>
                            <button type="button" onclick="this.closest('.form-modal').remove()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function addField() {
            const container = document.getElementById('formFields');
            const fieldItem = document.createElement('div');
            fieldItem.className = 'field-item';
            fieldItem.innerHTML = `
                <input type="text" placeholder="Field Label" class="field-label">
                <select class="field-type">
                    <option value="text">Text Input</option>
                    <option value="textarea">Text Area</option>
                    <option value="select">Dropdown</option>
                    <option value="checkbox">Checkbox</option>
                </select>
                <button type="button" onclick="removeField(this)">Remove</button>
            `;
            container.appendChild(fieldItem);
        }
        
        function removeField(btn) {
            btn.parentElement.remove();
        }
        
        function saveEnhancedForm() {
            const formName = document.getElementById('formName').value;
            const fields = [];
            
            document.querySelectorAll('.field-item').forEach(item => {
                const label = item.querySelector('.field-label').value;
                const type = item.querySelector('.field-type').value;
                if (label) {
                    fields.push({ label, type });
                }
            });
            
            if (formName && fields.length > 0) {
                try {
                    const result = formManager.createForm({ name: formName, fields });
                    
                    // Add to forms grid
                    const formsGrid = document.querySelector('.forms-grid');
                    if (formsGrid) {
                        const newFormCard = document.createElement('div');
                        newFormCard.className = 'form-card';
                        newFormCard.innerHTML = `
                            <h4>${formName}</h4>
                            <p>Custom form with ${fields.length} fields</p>
                            <button class="btn-glass" onclick="openCustomForm('${result.formId}')">Open Form</button>
                        `;
                        formsGrid.appendChild(newFormCard);
                    }
                    
                    // Show success modal with share info
                    const successModal = document.createElement('div');
                    successModal.className = 'form-modal';
                    successModal.innerHTML = `
                        <div class="form-modal-content">
                            <h3>✅ Form Created Successfully!</h3>
                            <div class="form-info">
                                <p><strong>Form Name:</strong> ${formName}</p>
                                <p><strong>PIN Code:</strong> <code>${result.pinCode}</code></p>
                                <p><strong>Share URL:</strong></p>
                                <input type="text" value="${result.shareUrl}" readonly onclick="this.select()">
                                <button onclick="copyToClipboard('${result.shareUrl}')">Copy Link</button>
                                <p><em>Save the PIN code - you'll need it to view responses!</em></p>
                            </div>
                            <button onclick="this.closest('.form-modal').remove()">Close</button>
                        </div>
                    `;
                    
                    document.querySelector('.form-modal').remove();
                    document.body.appendChild(successModal);
                    
                } catch (error) {
                    securityManager.showNotification('Failed to create form: ' + error.message, 'warning');
                }
            } else {
                securityManager.showNotification('Please fill in form name and add at least one field.', 'warning');
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                securityManager.showNotification('Link copied to clipboard!', 'info');
            });
        }
        
        function logout() {
            newAuthSystem.logout();
        }
        
        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('expanded');
                overlay.classList.toggle('active');
            });
            
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('expanded');
                overlay.classList.remove('active');
            });
        }
        
        function openCustomForm(formId) {
            window.open(`form.html?id=${formId}`, '_blank');
        }
        
        async function searchRobloxUser() {
            const username = document.getElementById('robloxSearch').value.trim();
            const resultsDiv = document.getElementById('robloxResults');
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
            
            try {
                const response = await fetch(`https://users.roblox.com/v1/users/search?keyword=${encodeURIComponent(username)}&limit=10`);
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    const user = data.data[0];
                    const avatarResponse = await fetch(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${user.id}&size=150x150&format=Png`);
                    const avatarData = await avatarResponse.json();
                    
                    resultsDiv.innerHTML = `
                        <div class="user-result">
                            <div class="user-avatar-container">
                                <img src="${avatarData.data[0]?.imageUrl || '/images/default-avatar.png'}" alt="${user.displayName}" class="user-avatar">
                            </div>
                            <div class="user-info">
                                <h4>${user.displayName}</h4>
                                <p class="username">@${user.name}</p>
                                <p class="user-id">ID: ${user.id}</p>
                                <div class="user-actions">
                                    <a href="https://www.roblox.com/users/${user.id}/profile" target="_blank" class="btn btn-secondary">
                                        <i class="fas fa-external-link-alt"></i> View Profile
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = '<div class="no-results"><i class="fas fa-user-slash"></i> No users found</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error"><i class="fas fa-exclamation-triangle"></i> Error searching for user</div>';
            }
        }
        
        function openIncidentReport() {
            const modal = document.createElement('div');
            modal.className = 'form-modal';
            modal.innerHTML = `
                <div class="form-modal-content">
                    <h3><i class="fas fa-flag"></i> Incident Report</h3>
                    <input type="text" id="robloxUsername" placeholder="Roblox Username" required>
                    <input type="text" id="discordUsername" placeholder="Discord Username" required>
                    <select id="reportType" required>
                        <option value="">Select Report Type</option>
                        <option value="Staff Report">Staff Report</option>
                        <option value="Incident Report" selected>Incident Report</option>
                        <option value="Other">Other</option>
                    </select>
                    <textarea id="reportDescription" placeholder="Describe the incident (max 1000 characters)" rows="6" maxlength="1000" required></textarea>
                    <input type="url" id="evidenceLink" placeholder="Evidence Link (optional)">
                    <label class="checkbox-option">
                        <input type="checkbox" id="agreeTicket" required>
                        <span>I understand I may be added to a ticket for further explanation</span>
                    </label>
                    <div class="form-actions">
                        <button onclick="submitIncidentReport()" class="btn-primary">Submit Report</button>
                        <button onclick="this.closest('.form-modal').remove()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function submitIncidentReport() {
            const robloxUsername = document.getElementById('robloxUsername').value.trim();
            const discordUsername = document.getElementById('discordUsername').value.trim();
            const reportType = document.getElementById('reportType').value;
            const description = document.getElementById('reportDescription').value.trim();
            const evidenceLink = document.getElementById('evidenceLink').value.trim();
            const agreeTicket = document.getElementById('agreeTicket').checked;
            
            if (!robloxUsername || !discordUsername || !reportType || !description || !agreeTicket) {
                alert('Please fill in all required fields and agree to the terms');
                return;
            }
            
            const reportData = {
                robloxUsername,
                discordUsername,
                reportType,
                description,
                evidence: evidenceLink
            };
            
            formSystem.submitReport(reportData);
            document.querySelector('.form-modal').remove();
            alert('Incident report submitted successfully!');
        }
        
        // Add search functionality
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('siteSearch');
            if (searchInput) {
                searchInput.addEventListener('input', siteSearch);
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        siteSearch();
                    }
                });
            }
            
            const robloxSearchInput = document.getElementById('robloxSearch');
            if (robloxSearchInput) {
                robloxSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchRobloxUser();
                    }
                });
            }
        });
    </script>
</body>

</html>