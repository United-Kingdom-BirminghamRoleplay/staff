<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - UKBRUM Staff</title>
    <link rel="icon" type="image/png" href="./images/ukbrum_png.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>

<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>

<body>
    <div id="sidebar-container"></div>

    <main class="main-content">
        <section class="top-search">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="siteSearch" placeholder="Search site content..." class="search-input" autocomplete="off">
                    <button class="filter-btn"><i class="fas fa-filter"></i></button>
                </div>
            </div>
            <div id="searchResults" class="search-results"></div>
        </section>
        
        <section class="greeting-section">
            <h1 class="greeting-text">Staff Schedule</h1>
            <p class="greeting-subtitle">View staff schedules, assignments, and availability for Birmingham Roleplay operations.</p>
        </section>

        <div id="timetableContainer">
            <!-- Timetable events will be loaded dynamically -->
        </div>
    </main>

    <div id="footer-container"></div>

    <script>
        const timetableEvents = [
            {
                name: 'Sunday Staff Meeting',
                day: 0, // Today
                hour: 19,
                minute: 0, // 1 minute from now
                icon: 'users',
                color: '#dc2626'
            },
            {
                name: 'Quota Reset',
                day: 5, // Friday
                hour: 20, // 8PM
                minute: 0,
                icon: 'refresh',
                color: '#f7931e'
            },
            {
                name: 'Staff of the Week Reset',
                day: 3, // Wednesday
                hour: 8, // 8AM
                minute: 0,
                icon: 'star',
                color: '#ff6b35'
            }
        ];

        function getNextEventTime(event) {
            const now = new Date();
            const nextEvent = new Date();
            
            // Set to today first
            nextEvent.setHours(event.hour, event.minute, 0, 0);
            
            // If event time has passed today, move to next occurrence
            if (nextEvent <= now) {
                nextEvent.setDate(now.getDate() + (event.day + 7 - now.getDay()) % 7);
                if (nextEvent <= now) {
                    nextEvent.setDate(nextEvent.getDate() + 7);
                }
            }
            
            return nextEvent;
        }

        function formatTimeRemaining(ms) {
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return `${days}d ${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        function loadTimetable() {
            const container = document.getElementById('timetableContainer');
            
            container.innerHTML = timetableEvents.map(event => {
                const nextTime = getNextEventTime(event);
                const now = new Date();
                const timeRemaining = nextTime - now;
                const totalWeekMs = 7 * 24 * 60 * 60 * 1000;
                const progressPercent = Math.max(0, Math.min(100, (1 - (timeRemaining / totalWeekMs)) * 100));
                const minutesLeft = Math.floor(timeRemaining / (1000 * 60));
                const secondsLeft = Math.floor((timeRemaining % (1000 * 60)) / 1000);
                const isCountdownMode = minutesLeft <= 2;
                
                return `
                    <div class="timetable-event ${isCountdownMode ? 'countdown-mode' : ''}" style="border-left: 4px solid ${event.color}">
                        <div class="event-header">
                            <div class="event-info">
                                <i class="fas fa-${event.icon}" style="color: ${event.color}"></i>
                                <h3>${event.name}</h3>
                            </div>
                            <div class="event-time">
                                <span class="next-time">${nextTime.toLocaleDateString('en-GB')} at ${nextTime.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}</span>
                                <span class="time-remaining">${formatTimeRemaining(timeRemaining)} remaining</span>
                            </div>
                        </div>
                        ${isCountdownMode ? `
                            <div class="final-countdown">
                                <div class="countdown-display" style="color: ${event.color}; text-shadow: 0 0 20px ${event.color}">
                                    <span class="countdown-minutes">${minutesLeft.toString().padStart(2, '0')}</span>
                                    <span class="countdown-separator">:</span>
                                    <span class="countdown-seconds">${secondsLeft.toString().padStart(2, '0')}</span>
                                </div>
                                <div class="countdown-label" style="color: ${event.color}">${event.name.includes('Meeting') ? 'MEETING STARTING' : event.name.includes('Reset') ? 'RESETTING' : 'STARTING SOON'}</div>
                            </div>
                        ` : `
                            <div class="countdown-bar">
                                <div class="countdown-progress" style="width: ${progressPercent}%; background: linear-gradient(90deg, ${event.color}, ${event.color}aa);"></div>
                                <div class="progress-percentage" style="color: ${event.color}">${Math.round(progressPercent)}%</div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function siteSearch() {
            const query = document.getElementById('siteSearch').value.toLowerCase();
            const results = document.getElementById('searchResults');
            
            if (!query) {
                results.innerHTML = '';
                return;
            }
            
            const searchableElements = document.querySelectorAll('h1, h2, h3, h4, p, li, td');
            const matches = [];
            
            searchableElements.forEach(el => {
                if (el.textContent.toLowerCase().includes(query)) {
                    matches.push({
                        text: el.textContent.substring(0, 100) + '...',
                        element: el
                    });
                }
            });
            
            if (matches.length > 0) {
                results.innerHTML = matches.map(match => `
                    <div class="search-result">
                        <p>${match.text}</p>
                    </div>
                `).join('');
            } else {
                results.innerHTML = '<div class="no-results">No results found</div>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadTimetable();
            setInterval(loadTimetable, 1000); // Update every second for countdown
            
            const searchInput = document.getElementById('siteSearch');
            if (searchInput) {
                searchInput.addEventListener('input', siteSearch);
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        siteSearch();
                    }
                });
            }
        });
        
        function logout() {
            if (window.authSystem) {
                window.authSystem.logout();
            } else {
                localStorage.removeItem('ukbrum_auth');
                location.reload();
            }
        }
    </script>
    <script src="js/components.js"></script>
    <script src="js/main.js"></script>
    <script src="js/auth.js"></script>
</body>

</html>